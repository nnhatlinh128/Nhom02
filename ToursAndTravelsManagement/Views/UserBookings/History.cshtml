@model UserMyBookingsViewModel
@using ToursAndTravelsManagement.Enums

@{
    ViewData["Title"] = "Lịch sử đặt tour";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .card-profile { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .status-upcoming { background-color: #e3f2fd; color: #0d47a1; }
    .status-completed { background-color: #e8f5e9; color: #1b5e20; }
    .status-cancelled { background-color: #ffebee; color: #b71c1c; }

    .payment-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .payment-paid { background-color: #e8f5e9; color: #1b5e20; }
    .payment-pending { background-color: #fff8e1; color: #ff8f00; }
    .payment-failed { background-color: #ffebee; color: #b71c1c; }
</style>

<div class="container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold" style="color:#27377D;">Lịch sử đặt tour</h3>

        <a asp-action="MyBookings"
           class="btn btn-outline-secondary btn-sm">
            ← Quay lại trang tài khoản
        </a>
    </div>

    @if (!Model.Bookings.Any())
    {
        <div class="text-center text-muted py-5">
            <i class="ri-calendar-event-line fs-1"></i>
            <p class="mt-3">Bạn chưa có booking nào.</p>
        </div>
    }
    else
    {
        @foreach (var booking in Model.Bookings.OrderByDescending(b => b.BookingDate))
        {
            <div class="card mb-3 border shadow-none
                @(booking.Status == BookingStatus.Cancelled ? "bg-light opacity-75" : "")">

                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="@booking.Tour?.Destination?.ImageUrl"
                             class="img-fluid rounded-start h-100 object-fit-cover"
                             style="@(booking.Status == BookingStatus.Cancelled ? "filter: grayscale(80%);" : "")"
                             alt="Tour Image">
                    </div>

                    <div class="col-md-8">
                        <div class="card-body">

                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="fw-bold mb-0">
                                    @booking.Tour?.Name
                                </h5>

                                @switch (booking.Status)
                                {
                                    case BookingStatus.Pending:
                                        <span class="status-badge status-upcoming">Chờ xác nhận</span>
                                        break;
                                    case BookingStatus.Confirmed:
                                        <span class="status-badge status-upcoming">Đã xác nhận</span>
                                        break;
                                    case BookingStatus.Completed:
                                        <span class="status-badge status-completed">Hoàn thành</span>
                                        break;
                                    case BookingStatus.Cancelled:
                                        <span class="status-badge status-cancelled">Đã hủy</span>
                                        break;
                                }
                            </div>

                            <div class="text-muted small mb-2">
                                <span class="me-3">
                                    <i class="ri-calendar-line"></i>
                                    @booking.BookingDate.ToString("dd/MM/yyyy")
                                </span>
                                <span class="me-3">
                                    <i class="ri-user-line"></i>
                                    @booking.NumberOfParticipants người
                                </span>
                                <span>
                                    <i class="ri-ticket-line"></i>
                                    #@booking.BookingId
                                </span>
                            </div>

                            <div class="small mb-3">
                                <span class="me-3 text-muted">
                                    <i class="ri-bank-card-line"></i>
                                    Thanh toán:
                                    <strong>@booking.PaymentMethod</strong>
                                </span>

                                @switch (booking.PaymentStatus)
                                {
                                    case PaymentStatus.Completed:
                                        <span class="payment-badge payment-paid">Đã thanh toán</span>
                                        break;
                                    case PaymentStatus.Pending:
                                        <span class="payment-badge payment-pending">Chờ thanh toán</span>
                                        break;
                                    case PaymentStatus.Failed:
                                        <span class="payment-badge payment-failed">Thanh toán thất bại</span>
                                        break;
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-end border-top pt-3">
                                <div>
                                    <small class="text-muted">Tổng thanh toán</small>
                                    <div class="fw-bold fs-5
                                        @(booking.Status == BookingStatus.Cancelled ? "text-muted text-decoration-line-through" : "text-primary")">
                                        @booking.TotalPrice.ToString("N0")đ
                                    </div>
                                </div>

                                @if (booking.Status != BookingStatus.Cancelled
                                     && booking.Status != BookingStatus.Completed)
                                {
                                    <form asp-action="CancelBooking" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="bookingId" value="@booking.BookingId" />
                                        <button class="btn btn-sm btn-outline-danger rounded-pill px-3">
                                            Hủy tour
                                        </button>
                                    </form>
                                }
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        }
    }

</div>
